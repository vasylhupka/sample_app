function ImprovedCodeEditor(){function e(e){var t=new XMLHttpRequest;return t.open("HEAD",e,!1),t.send(),200==t.status}function t(){a.cme.refresh(),a.cme.focus()}function n(e){for(var t=a.cme.getDoc().lineCount(),n=e?"smart":"substract",o=!1,i=0,c=0;t>c;c++){var r=a.cme.getLine(c);o?(o=-1==r.search("</pre>"),i=0):o=-1!=r.search("<pre>"),o?(a.cme.indentLine(c,i*a.cme.getOption("indentUnit")),i++):a.cme.indentLine(c,n)}}function o(e){var t=document.getElementById("htmlSource");CodeMirror.defineInitHook(function(e){e.focus();var t=e.getSearchCursor(String.fromCharCode(l),!1);t.findNext()&&(e.setCursor(t.to()),t.replace(""))});var n=CodeMirror.fromTextArea(t,{indentUnit:e.indentUnit,tabSize:e.tabSize,lineNumbers:e.lineNumbers,theme:e.theme,lineWrapping:e.lineWrapping,mode:{name:"xml",alignCDATA:!0,htmlMode:!0}});return document.getElementById("htmlSource").value=n.getDoc().getValue(),n}function i(){if(""==a.theme||"default"==a.theme)return null;var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",a.themeUrl+a.theme+".css"),document.getElementsByTagName("head")[0].appendChild(e)}function c(){var e=tinyMCEPopup.dom.getViewPort(window);a.cme.setSize("100%",e.h-100)}function r(t,n){return""==t||"default"==t?"default":e(n+t+".css")?t:""}function u(e){var t,n,o=document.getElementById("htmlSource");o.wrap=e,tinymce.isIE||(t=o.value,n=o.cloneNode(!1),n.setAttribute("wrap",e),o.parentNode.replaceChild(n,o),n.value=t)}function d(e,t,n){e.removeClass(n),e.addClass(t)}function m(){var e=a.cme.getDoc().historySize(),t=$("#undo_btn");e.undo<1?d(t,"off","on"):d(t,"on","off");var n=$("#redo_btn");e.redo<1?d(n,"off","on"):d(n,"on","off")}var a=null,l=0,s=null;this.init=function(){tinyMCEPopup.resizeToInnerSize(),tinymce.isGecko&&(document.body.spellcheck=tinyMCEPopup.editor.getParam("gecko_spellcheck")),this.resizeInputs();var e=tinyMCEPopup.editor.getContent({source_view:!0});if(e=e.replace(/<span\s+class="CuRCaRet"([^>]*)>([^<]*)<\/span>/gm,String.fromCharCode(l)),tinyMCEPopup.editor.dom.remove(tinyMCEPopup.editor.dom.select(".CuRCaRet")),document.getElementById("htmlSource").value=e,u("soft"),a=tinyMCEPopup.getWindowArg("settings"),a.optionsBar)document.getElementById("wraped").checked=a.lineWrapping,document.getElementById("highlighting").checked=!0,document.getElementById("indented").checked=a.autoIndent,document.getElementById("linenumbers").checked=a.lineNumbers;else{var t=document.getElementById("optionsBar");t.parentNode.removeChild(t)}a.url=tinyMCEPopup.getWindowArg("plugin_url"),a.themeUrl="js/codemirror/theme/",a.theme=r(a.theme,a.themeUrl),i(),a.cme=o(a),s=a.cme.getDoc().getValue(),c(),a.autoIndent&&n(!0),a.cme.setOption("extraKeys",{Tab:function(e){var t=Array(e.getOption("indentUnit")+1).join(" ");e.replaceSelection(t)}}),a.cme.on("change",function(){m()}),a.cme.getDoc().clearHistory(),m()},this.cancel=function(){tinyMCEPopup.editor.setContent(s,{source_view:!0}),tinyMCEPopup.close()},this.resizeInputs=function(){var e,t=tinyMCEPopup.dom.getViewPort(window);e=document.getElementById("htmlSource"),e&&(e.style.width=t.w-20+"px",e.style.height=t.h-65+"px"),null!==a&&c()},this.saveContent=function(){var e=document.getElementById("htmlSource").value;null!==a&&(e=a.cme.getDoc().getValue()),tinyMCEPopup.editor.setContent(e,{source_view:!0}),tinyMCEPopup.close()},this.toggleHighlighting=function(e){e.checked?a.cme.setOption("theme",a.theme):a.cme.setOption("theme","none");var n=e.checked?"on":"off",o=e.checked?"off":"on";d($(e).parent(),n,o),t()},this.toggleIndent=function(e){n(e.checked);var o=e.checked?"on":"off",i=e.checked?"off":"on";d($(e).parent(),o,i),t()},this.toggleLineNumbers=function(e){a.cme.setOption("lineNumbers",e.checked);var n=e.checked?"on":"off",o=e.checked?"off":"on";d($(e).parent(),n,o),t()},this.toggleWordWrap=function(e){a.cme.setOption("lineWrapping",e.checked);var n=e.checked?"on":"off",o=e.checked?"off":"on";d($(e).parent(),n,o),t()},this.redo=function(){a.cme.getDoc().redo(),t()},this.undo=function(){a.cme.getDoc().undo(),t()}}tinyMCEPopup.requireLangPack();var ice=new ImprovedCodeEditor;tinyMCEPopup.onInit.add(ice.init,ice);